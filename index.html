<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background-color: #f4f4f9; color: #333; display:flex; flex-direction:column; align-items:center; padding:10px;}
h3 { font-size:24px; margin-bottom:10px;}
#currentInfo, #todayRecords { width:100%; max-width:400px; margin-top:10px; padding:10px; border-radius:10px; background:#fff; box-shadow:0 0 5px rgba(0,0,0,0.1);}
.status-box { display:inline-block; padding:5px 10px; border-radius:20px; font-weight:bold;}
.status-company { color:green; border:1px solid green; }
.status-unknown { color:red; border:1px solid red; }
button { margin:5px; padding:10px 20px; font-size:16px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;}
#btnStart { background-color:#3498db; color:white;}
#btnEnd { background-color:#e74c3c; color:white;}
#btnMakeUp { background-color:#f39c12; color:white;}
</style>
</head>
<body>
<h3 id="greeting">æ‚¨å¥½</h3>
<div id="currentInfo">
<p id="currentDate">æ­£åœ¨ç²å–ç¾åœ¨æ™‚åˆ»...</p>
<p>é€£ç·šç‹€æ…‹: <span id="ipStatus">æª¢æ¸¬ä¸­...</span></p>
</div>

<div>
<button id="btnStart">ä¸Šç­æ‰“å¡</button>
<button id="btnEnd">ä¸‹ç­æ‰“å¡</button>
<button id="btnMakeUp">è£œæ‰“å¡</button>
</div>

<div id="todayRecords">
<h4>ä»Šæ—¥æ‰“å¡ç´€éŒ„</h4>
<ul id="recordsList"></ul>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyrLQZv08u10DESc-Bppil1xBu86sU84dEz6oBBlJvBNkr-vdNiwkKvFnCJ77IKVEE/exec"; // Google Apps Script POST URL
const COMPANY_IPS = ["114.34.60.48","27.240.227.0"]; // å¤šå€‹å…¬å¸IP

function getCurrentTimeText(){ return new Date().toLocaleString("zh-TW"); }
function updateCurrentTime(){ document.getElementById("currentDate").textContent = "ç¾åœ¨æ™‚åˆ»: " + getCurrentTimeText(); }
setInterval(updateCurrentTime,1000);
updateCurrentTime();

async function detectIP(){
    try{
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        const ipEl = document.getElementById("ipStatus");
        if(COMPANY_IPS.includes(data.ip)){
            ipEl.innerHTML = `<span class="status-box status-company">å·²é€£ç·šå…¬å¸ç¶²è·¯ (${data.ip})</span>`;
        } else {
            ipEl.innerHTML = `<span class="status-box status-unknown">ä¸æ˜é€£ç·š (${data.ip})</span>`;
        }
        return data.ip;
    }catch(e){
        document.getElementById("ipStatus").textContent="IP å–å¾—å¤±æ•—";
        return "";
    }
}

async function performClockIn(data){
    const res = await fetch(API_ENDPOINT,{ method:"POST", body: JSON.stringify(data) });
    return await res.json();
}

async function clockIn(status){
    const profile = await liff.getProfile();
    const userId = profile.userId;
    const displayName = profile.displayName;
    const ip = await detectIP();

    const data = { ip, userId, displayName, status };
    const response = await performClockIn(data);
    if(response.message==="å¯«å…¥æˆåŠŸ"){
        Swal.fire({icon:'success', title:'ğŸ‰ æ‰“å¡æˆåŠŸ', html:`${status} æ™‚é–“ï¼š${response.date} ${response.time}`, timer:2000, showConfirmButton:false});
        loadTodayRecords(userId);
    } else {
        Swal.fire({icon:'error', title:'ğŸ˜¥ æ‰“å¡å¤±æ•—', timer:2000, showConfirmButton:false});
    }
}

async function makeUpClockIn(){
    const profile = await liff.getProfile();
    const userId = profile.userId;
    const displayName = profile.displayName;

    const today = new Date().toISOString().slice(0,10);
    const nowTime = new Date().toTimeString().slice(0,5);

    const { value: formValues } = await Swal.fire({
        title:'è£œæ‰“å¡è¨­å®š',
        html:
            `<input type="date" id="swal-date" class="swal2-input" value="${today}">`+
            `<input type="time" id="swal-time" class="swal2-input" value="${nowTime}">`+
            `<select id="swal-status" class="swal2-input">
                <option value="ä¸Šç­">ä¸Šç­</option>
                <option value="ä¸‹ç­">ä¸‹ç­</option>
             </select>`,
        focusConfirm:false,
        showCancelButton:true,
        preConfirm:()=>({
            date: document.getElementById('swal-date').value,
            time: document.getElementById('swal-time').value,
            status: document.getElementById('swal-status').value
        })
    });

    if(!formValues) return;

    const ip = COMPANY_IPS[0]; // è£œæ‰“å¡é è¨­å…¬å¸ IP
    const data = {
        ip, userId, displayName, status: formValues.status,
        customDate: formValues.date, customTime: formValues.time,
        note: "è£œæ‰“å¡"
    };

    const response = await performClockIn(data);
    if(response.message==="å¯«å…¥æˆåŠŸ"){
        Swal.fire({icon:'success', title:'ğŸ‰ è£œæ‰“å¡æˆåŠŸ', html:`æ™‚é–“ï¼š${data.customDate} ${data.customTime}`, timer:2000, showConfirmButton:false});
        loadTodayRecords(userId);
    }else{
        Swal.fire({icon:'error', title:'ğŸ˜¥ è£œæ‰“å¡å¤±æ•—', timer:2000, showConfirmButton:false});
    }
}

async function loadTodayRecords(userId){
    const today = new Date().toISOString().slice(0,10);
    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const records = await res.json();
    const ul = document.getElementById("recordsList");
    ul.innerHTML="";
    records.forEach(r=>{
        const li = document.createElement("li");
        li.textContent = `${r.status} - ${r.time}${r.note ? ' ('+r.note+')' : ''}`;
        ul.appendChild(li);
    });
}

async function main(){
    await liff.init({ liffId:"2008504718-nmXP0WRV" });
    if(!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    document.getElementById("greeting").textContent = `${profile.displayName} æ‚¨å¥½`;

    document.getElementById("btnStart").onclick = ()=>clockIn("ä¸Šç­");
    document.getElementById("btnEnd").onclick = ()=>clockIn("ä¸‹ç­");
    document.getElementById("btnMakeUp").onclick = makeUpClockIn;

    await detectIP();
    loadTodayRecords(profile.userId);
}

window.onload = main;
</script>
</body>
</html>























