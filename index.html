<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body { font-family: 'Arial', sans-serif; background-color:#f4f4f9; color:#333; display:flex; flex-direction:column; align-items:center; padding:10px; }
  h3 { font-size:24px; font-weight:600; color:#2c3e50; margin-bottom:5px; }
  #greeting { font-size:20px; margin:10px 0; font-weight:500; }
  button { font-size:20px; padding:15px 30px; margin:5px; border:none; border-radius:30px; cursor:pointer; transition:0.2s; background:linear-gradient(145deg,#f44336,#ff5733); color:white; font-weight:bold; }
  button:hover { transform:translateY(-3px); background:linear-gradient(145deg,#ff5733,#f44336); }
  .disabled { background:#e0e0e0; color:#aaa; cursor:not-allowed; }
  #ipStatus { font-size:16px; font-weight:bold; margin:10px 0; }
  #records { margin-top:15px; width:90%; max-width:500px; }
  .recordItem { padding:5px 10px; background:#fff; margin:5px 0; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<h3>奇可智能打卡系統</h3>
<div id="greeting">用戶您好</div>
<div id="ipStatus">正在獲取 IP...</div>

<div>
  <button id="clockInBtn" onclick="handleClockIn('上班')">上班打卡</button>
  <button id="clockOutBtn" onclick="handleClockIn('下班')">下班打卡</button>
  <button id="makeupBtn" onclick="handleMakeupClockIn()">補打卡</button>
</div>

<h4>今日打卡紀錄</h4>
<div id="records"></div>

<script>
const COMPANY_IPS = ["114.34.60.48","27.240.227.0","125.228.248.110","114.34.128.159","220.134.230.241"];
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycby99518DOcO8TEkwIdmgBmhhAB6WdayK8d5UzLHN0OXSJTMwOdH8oBkDaE7_6-x4BZ7/exec";
let userIpCache = null;
const USERNAME = "莊秀山"; // 可改成動態

document.getElementById("greeting").textContent = USERNAME + " 您好";

async function getUserIP() {
  if (userIpCache) return userIpCache;
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    userIpCache = data.ip;
    document.getElementById("ipStatus").textContent = COMPANY_IPS.includes(userIpCache) ? "已連接公司網路" : "異地連線";
    return userIpCache;
  } catch(e){
    console.error("IP 取得失敗", e);
    document.getElementById("ipStatus").textContent = "IP 取得失敗";
    return null;
  }
}

function getTodayKey(type) {
  const today = new Date().toISOString().split("T")[0];
  return type + "_" + today;
}

function addRecord(type,time){
  const recordDiv = document.getElementById("records");
  const div = document.createElement("div");
  div.className = "recordItem";
  div.textContent = `${type}打卡: ${time}`;
  recordDiv.appendChild(div);
}

function loadTodayRecords() {
  const types = ["上班","下班","補打卡"];
  types.forEach(type=>{
    const key = getTodayKey(type);
    const val = localStorage.getItem(key);
    if(val) addRecord(type,val);
  });
}

function lockButton(btnId){
  const btn = document.getElementById(btnId);
  btn.classList.add("disabled");
  btn.disabled = true;
}

function unlockButtonsIfNewDay(){
  const lastDate = localStorage.getItem("lastDate");
  const today = new Date().toISOString().split("T")[0];
  if(lastDate !== today){
    ["clockInBtn","clockOutBtn","makeupBtn"].forEach(id=>{
      const btn = document.getElementById(id);
      btn.classList.remove("disabled");
      btn.disabled = false;
    });
    localStorage.setItem("lastDate",today);
  }
}

unlockButtonsIfNewDay();
loadTodayRecords();

async function handleClockIn(type){
  const ip = await getUserIP();
  const now = new Date().toLocaleTimeString("zh-TW");
  if(COMPANY_IPS.includes(ip)){
    Swal.fire({icon:"success", title:`${type}打卡成功`, text:`打卡時間：${now}`, showConfirmButton:false, timer:3000});
    addRecord(type,now);
    localStorage.setItem(getTodayKey(type),now);
    const btnId = type==="上班"?"clockInBtn":"clockOutBtn";
    lockButton(btnId);
  } else {
    Swal.fire({icon:"warning", title:"異地打卡請忽略", text:"IP 不符", showConfirmButton:false, timer:3000});
    addRecord(type + " (異地)",now);
  }

  // 可加入 POST API
  // await fetch(API_ENDPOINT, {method:"POST", body:JSON.stringify({ip,type,time:now})});
}

async function handleMakeupClockIn(){
  const ip = await getUserIP();
  const {value: reason} = await Swal.fire({
    title:'補打卡理由',
    input:'text',
    inputPlaceholder:'請輸入補打卡原因',
    showCancelButton:true,
    confirmButtonText:'送出',
    cancelButtonText:'取消',
    width:'80%',
    padding:'3em',
    inputAttributes:{ autocapitalize:'off', style:'font-size:20px; height:2.5em;' },
    didOpen:()=>{ const input = Swal.getInput(); input.style.fontSize="22px"; input.style.height="50px"; }
  });
  if(!reason) return;
  const now = new Date().toLocaleTimeString("zh-TW");
  if(COMPANY_IPS.includes(ip)){
    Swal.fire({icon:"success", title:"補打卡成功", text:`打卡時間：${now}`, showConfirmButton:false, timer:3000});
    addRecord("補打卡",now);
    localStorage.setItem(getTodayKey("補打卡"),now);
    lockButton("makeupBtn");
  } else {
    Swal.fire({icon:"warning", title:"異地打卡請忽略", text:"IP 不符", showConfirmButton:false, timer:3000});
    addRecord("補打卡 (異地)",now);
  }
  // 可加入 POST API
  // await fetch(API_ENDPOINT, {method:"POST", body:JSON.stringify({ip,type:"補打卡",reason,time:now})});
}
</script>
</body>
</html>






















