
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; height:100vh; margin:0; padding:10px;}
h3 { font-size:24px; font-weight:600; color:#2c3e50; margin-bottom:10px;}
#currentInfo { display:flex; flex-direction:column; align-items:center; justify-content:center; margin-top:5px; width:100%; }
#currentInfo p { font-size:16px; margin:5px 0; color:#34495e; font-weight:500; text-align:center;}
button { margin:10px; padding:10px 20px; font-size:16px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;}
#btnStart { background-color:#3498db; color:white;}
#btnEnd { background-color:#e74c3c; color:white;}
#btnMakeUp { background-color:#f39c12; color:white;}
#countdownWrapper { margin-top:10px; width:100%; background-color:#ddd; height:40px; border-radius:20px; display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden; display:none;}
#countdownBar { height:100%; background-color:#3498db; border-radius:20px; width:100%; position:absolute; transition:width 1s linear;}
#countdownText { position:relative; z-index:2; font-size:18px; font-weight:bold; color:white;}
#resultText { display:none; position:relative; z-index:3; font-size:18px; font-weight:bold; text-align:center;}
#todayRecords { margin-top:10px; font-size:16px; }
@keyframes pulseFade {0% {opacity:1; transform:scale(1);} 50% {opacity:0.5; transform:scale(1.05);} 100% {opacity:1; transform:scale(1);} }
.pulsingText {color:#3498db !important; animation:pulseFade 1.5s infinite;}
</style>
</head>
<body>
<h3>è¬è¬ä½¿ç”¨å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</h3>
<div id="currentInfo">
<p id="currentDate">æ­£åœ¨ç²å–ç¾åœ¨æ™‚åˆ»...</p>
</div>
<div>
<button id="btnStart">ä¸Šç­æ‰“å¡</button>
<button id="btnEnd">ä¸‹ç­æ‰“å¡</button>
<button id="btnMakeUp">è£œæ‰“å¡</button>
</div>
<div id="countdownWrapper">
<div id="countdownBar"></div>
<div id="countdownText">æ‰“å¡ä¸­ï¼Œè«‹ç¨å€™...</div>
<div id="resultText"></div>
</div>
<div id="todayRecords"></div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxZROnfUGDFvmmjPtzaKWJ73Jwo_h1c1ahxqZLVdqY9OVGMvjQIaoh6MutBuydumpZi/exec";
let todayRecord = { ä¸Šç­:null, ä¸‹ç­:null };
let lastDateCheck = new Date().toLocaleDateString();

function getCurrentTimeText() {
    const now = new Date();
    return now.toLocaleString("zh-TW");
}

function updateCurrentTime() {
    document.getElementById("currentDate").textContent = "ç¾åœ¨æ™‚åˆ»: " + getCurrentTimeText();
}
setInterval(updateCurrentTime, 1000);
updateCurrentTime();

async function performClockIn(data) {
    const res = await fetch(API_ENDPOINT, {
        method: "POST",
        body: JSON.stringify(data),
    });
    return await res.json();
}

async function clockIn(status, isMakeUp=false) {
    if (!isMakeUp && todayRecord[status]) {
        Swal.fire({icon:'warning', title:'å·²æ‰“éå¡', text:`ä»Šæ—¥${status}å·²æ‰“å¡ï¼Œç„¡æ³•é‡è¤‡æ‰“å¡ã€‚`});
        return;
    }

    const wrapper = document.getElementById("countdownWrapper");
    const bar = document.getElementById("countdownBar");
    const text = document.getElementById("countdownText");
    const resultEl = document.getElementById("resultText");

    wrapper.style.display = "flex";
    bar.style.width = "100%";
    text.style.display = "block";
    resultEl.style.display = "none";
    text.classList.remove("pulsingText");

    const profile = await liff.getProfile();
    const userId = profile.userId;
    const displayName = profile.displayName;

    const ipRes = await fetch("https://api.ipify.org?format=json").then(r=>r.json()).catch(()=>({ip:""}));
    const ip = ipRes.ip || "";

    const clockPromise = performClockIn({ ip, userId, displayName, status, isMakeUp });

    let duration = 3;
    let width = 100;
    const countdown = setInterval(() => {
        width -= 100 / duration;
        bar.style.width = width + "%";
    }, 1000);

    setTimeout(() => {
        clearInterval(countdown);
        bar.style.display = "none";
        text.classList.add("pulsingText");
    }, duration * 1000);

    const response = await clockPromise;
    text.classList.remove("pulsingText");
    text.style.display = "none";
    resultEl.style.display = "block";

    if (response.message === "å¯«å…¥æˆåŠŸ") {
        todayRecord[status] = response.time;
        updateTodayRecords();
        resultEl.textContent = `ğŸ˜€ ${status}æ‰“å¡æˆåŠŸ! æ™‚é–“: ${response.time}`;
        resultEl.style.color = "#4CAF50";
        Swal.fire({ icon: 'success', title: 'ğŸ‰ æ‰“å¡æˆåŠŸï¼', html: `<strong>æ‰“å¡æ™‚é–“ï¼š</strong>${response.date} ${response.time}`, showConfirmButton: false, timer:2000 });
        updateButtonLock();
    } else {
        resultEl.textContent = "ğŸ˜¥ æ‰“å¡å¤±æ•—ï¼Œè«‹é‡è©¦";
        resultEl.style.color = "red";
        Swal.fire({ icon: 'error', title: 'ğŸ˜¥ æ‰“å¡å¤±æ•—', html: 'è«‹é‡æ–°æ“ä½œ', showConfirmButton: false, timer:2000 });
    }
}

function updateTodayRecords() {
    const el = document.getElementById("todayRecords");
    el.innerHTML = `ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>ä¸Šç­ï¼š${todayRecord.ä¸Šç­||"å°šæœªæ‰“å¡"}<br>ä¸‹ç­ï¼š${todayRecord.ä¸‹ç­||"å°šæœªæ‰“å¡"}`;
}

function updateButtonLock() {
    document.getElementById("btnStart").disabled = todayRecord.ä¸Šç­ && todayRecord.ä¸‹ç­ ? true : false;
    document.getElementById("btnEnd").disabled = todayRecord.ä¸Šç­ && todayRecord.ä¸‹ç­ ? true : false;
}

function autoResetAtMidnight() {
    const nowDate = new Date().toLocaleDateString();
    if (nowDate !== lastDateCheck) {
        lastDateCheck = nowDate;
        todayRecord = { ä¸Šç­:null, ä¸‹ç­:null };
        updateTodayRecords();
        updateButtonLock();
        console.log("å·²è‡ªå‹•åˆ·æ–°ï¼ŒæŒ‰éˆ•è§£é–æ–°çš„ä¸€å¤©");
    }
}
setInterval(autoResetAtMidnight, 60*1000);

async function main() {
    await liff.init({ liffId: "2008504718-nmXP0WRV" });
    if (!liff.isLoggedIn()) liff.login();

    document.getElementById("btnStart").onclick = () => clockIn("ä¸Šç­");
    document.getElementById("btnEnd").onclick = () => clockIn("ä¸‹ç­");
    document.getElementById("btnMakeUp").onclick = async () => {
        const { value: formValues } = await Swal.fire({
            title: 'è£œæ‰“å¡',
            html:
              '<input id="swal-date" class="swal2-input" placeholder="æ—¥æœŸ yyyy-mm-dd">' +
              '<input id="swal-time" class="swal2-input" placeholder="æ™‚é–“ HH:mm:ss">' +
              '<select id="swal-status" class="swal2-input"><option value="ä¸Šç­">ä¸Šç­</option><option value="ä¸‹ç­">ä¸‹ç­</option></select>',
            focusConfirm: false,
            preConfirm: () => {
              return {
                date: document.getElementById('swal-date').value,
                time: document.getElementById('swal-time').value,
                status: document.getElementById('swal-status').value
              }
            }
        });
        if (formValues) {
            const profile = await liff.getProfile();
            await performClockIn({
                ip: '',
                userId: profile.userId,
                displayName: profile.displayName,
                status: formValues.status,
                date: formValues.date,
                time: formValues.time,
                isMakeUp: true
            });
            Swal.fire('å®Œæˆ', 'è£œæ‰“å¡æˆåŠŸ', 'success');
        }
    };
}
window.onload = main;
</script>
</body>
</html>




















