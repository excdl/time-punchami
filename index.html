<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; display:flex; flex-direction:column; align-items:center; margin:20px;}
#userInfo { text-align:center; font-size:18px; margin-bottom:10px; }
#statusInfo { text-align:center; font-size:16px; margin-bottom:20px; padding:5px 15px; border-radius:20px; display:inline-block; }
button { margin:5px; padding:10px 20px; font-size:16px; border-radius:8px; cursor:pointer; font-weight:bold; }
#btnStart { background-color:#3498db; color:white; }
#btnEnd { background-color:#e74c3c; color:white; }
#btnMakeup { background-color:#f39c12; color:white; }
#todayRecords { margin-top:20px; width:90%; border:1px solid #ccc; padding:10px; border-radius:8px; min-height:50px; }
#countdownWrapper { margin-top:20px; width:120px; height:120px; position:relative; display:none; }
#circleBg, #circleProgress { fill:none; stroke-width:12; transform: rotate(-90deg); transform-origin: 50% 50%; }
#circleBg { stroke:#ddd; }
#circleProgress { stroke:#3498db; stroke-linecap:round; stroke-dasharray: 377; stroke-dashoffset: 0; }
#countdownText { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; text-align:center; }
</style>
</head>
<body>

<div id="userInfo">正在獲取使用者資訊...</div>
<div id="statusInfo"></div>

<div>
<button id="btnStart">上班打卡</button>
<button id="btnEnd">下班打卡</button>
<button id="btnMakeup">補打卡</button>
</div>

<div id="countdownWrapper">
  <svg width="120" height="120">
    <circle id="circleBg" cx="60" cy="60" r="60"></circle>
    <circle id="circleProgress" cx="60" cy="60" r="60"></circle>
  </svg>
  <div id="countdownText">打卡中...</div>
</div>

<div id="todayRecords">今日打卡紀錄：</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzhMnFoesT-XqSnKpWOWR_5tMz_BAypaW4gG6s7UY255AyrCpQOEBLQINNGBOQwoo0b/exec";
const COMPANY_IPS = ["114.34.60.48","27.240.227.0"]; // 公司IP清單

async function getIP() {
  try { const res = await fetch("https://api.ipify.org?format=json"); const data = await res.json(); return data.ip; }
  catch { return ""; }
}

async function updateUserInfo() {
  await liff.init({ liffId: "2008504718-nmXP0WRV" });
  if(!liff.isLoggedIn()) liff.login();
  const profile = await liff.getProfile();
  window.userId = profile.userId;
  window.userName = profile.displayName;
  const ip = await getIP();
  const isCompany = COMPANY_IPS.includes(ip);
  document.getElementById("userInfo").textContent = profile.displayName + " 您好";
  const statusEl = document.getElementById("statusInfo");
  statusEl.textContent = isCompany ? "已連線公司網路" : "不明連線";
  statusEl.style.backgroundColor = isCompany ? "#d4f4dd" : "#f8d4d4";
  statusEl.style.color = isCompany ? "green" : "red";
}

async function performClockIn(status, customDate="", customTime="") {
  const ip = await getIP();
  const wrapper = document.getElementById("countdownWrapper");
  const circle = document.getElementById("circleProgress");
  const text = document.getElementById("countdownText");
  wrapper.style.display = "block";
  text.textContent = "打卡中...";
  const radius = 60;
  const circumference = 2 * Math.PI * radius;
  circle.style.strokeDasharray = circumference;
  circle.style.strokeDashoffset = 0;

  let duration = 3; // 秒
  const steps = duration * 20; // 每50ms更新
  for(let i=0;i<=steps;i++){
    await new Promise(r=>setTimeout(r,50));
    const progress = i/steps;
    circle.style.strokeDashoffset = circumference * (1-progress);
    // 顏色漸變藍->綠
    const rC = Math.round(52*(1-progress));
    const gC = Math.round(152*(1-progress)+202*progress);
    const bC = Math.round(219*(1-progress));
    circle.style.stroke = `rgb(${rC},${gC},${bC})`;
  }

  // 呼叫API
  const res = await fetch(API_ENDPOINT, {
    method:"POST",
    body: JSON.stringify({ userId:window.userId, displayName:window.userName, status, ip, customDate, customTime })
  });
  const data = await res.json();
  wrapper.style.display="none";
  if(data.message==="寫入成功") {
    Swal.fire({icon:'success', title:'打卡成功', html:`${status} ${data.date} ${data.time}`, timer:2000});
    updateTodayRecords();
  } else {
    Swal.fire({icon:'error', title:'打卡失敗', html:data.message, timer:2000});
  }
}

async function updateTodayRecords() {
  const today = new Date().toISOString().slice(0,10);
  const res = await fetch(API_ENDPOINT + `?action=getToday&userId=${window.userId}&date=${today}`);
  const data = await res.json();
  const container = document.getElementById("todayRecords");
  if(data.length===0) container.textContent = "今日打卡紀錄：無";
  else container.innerHTML = "今日打卡紀錄：<br>" + data.map(r=>`${r.status} ${r.time}`).join("<br>");
}

document.getElementById("btnStart").onclick = ()=>performClockIn("上班");
document.getElementById("btnEnd").onclick = ()=>performClockIn("下班");
document.getElementById("btnMakeup").onclick = async ()=>{
  const { value: formValues } = await Swal.fire({
    title: '補打卡設定',
    html: `
      <label>日期:</label><input type="date" id="swalDate" class="swal2-input"><br>
      <label>時間:</label><input type="time" id="swalTime" class="swal2-input"><br>
      <label>動態:</label>
      <select id="swalStatus" class="swal2-select">
        <option>上班</option><option>下班</option>
      </select>`,
    focusConfirm: false,
    preConfirm: () => [
      document.getElementById('swalDate').value,
      document.getElementById('swalTime').value,
      document.getElementById('swalStatus').value
    ],
    showCancelButton:true,
    confirmButtonText:'完成'
  });
  if(formValues) performClockIn(formValues[2], formValues[0], formValues[1]);
};

window.onload = async ()=>{
  await updateUserInfo();
  await updateTodayRecords();
};
</script>
</body>
</html>
























