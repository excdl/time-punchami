<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>LIFF 打卡</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<h1>打卡系統</h1>
<button id="clock-in">上班打卡</button>
<button id="clock-out">下班打卡</button>

<script>
let userProfile = null;
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbzVC7we_LY0_LTO2Eho-AyF5pp9k4rB2eU4vJz1-PBC5QpGaPEeK_0Tf69O2uD68yMQ/exec";

async function initLiff() {
    await liff.init({ liffId: "2008504718-nmXP0WRV" });
    if (!liff.isLoggedIn()) liff.login();
    else userProfile = await liff.getProfile();
}

async function clock(type) {
    if (!userProfile) return alert("尚未取得用戶資訊");
    const record = {
        userId: userProfile.userId,
        name: userProfile.displayName,
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString(),
        type: type
    };
    try {
        const res = await fetch(SHEET_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(record)
        });
        const result = await res.json();
        if (result.status === "success") alert(type + "打卡成功！");
        else alert("打卡失敗: " + result.message);
    } catch(err) {
        alert("打卡失敗: " + err.message);
    }
}

document.getElementById("clock-in").addEventListener("click", ()=>clock("上班"));
document.getElementById("clock-out").addEventListener("click", ()=>clock("下班"));

initLiff();
</script>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>打卡系統報表</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        button:disabled { background-color: #ccc; color: #666; cursor: not-allowed; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 5px; text-align: center; }
    </style>
</head>
<body>
    <h1>打卡系統報表</h1>

    <button id="clock-in">上班打卡</button>
    <button id="clock-out">下班打卡</button>
    <button id="clear-records">清除本地紀錄</button>

    <h2>報表選擇</h2>
    <select id="report-type">
        <option value="week">本週報表</option>
        <option value="month">本月報表</option>
    </select>
    <button id="generate-report">生成報表</button>

    <h2>打卡報表</h2>
    <table id="report-table">
        <thead>
            <tr>
                <th>日期 / 使用者</th>
                <th>上班次數</th>
                <th>下班次數</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let userProfile = null;
        const STORAGE_KEY = "attendanceRecords";

        async function initializeLiff() {
            await liff.init({ liffId: "2008504718-nmXP0WRV" });

            if (liff.isLoggedIn()) {
                userProfile = await liff.getProfile();
            } else { liff.login(); }
        }

        function saveRecordToLocal(record) {
            let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            records.push(record);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        function isAlreadyClockedToday(type) {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const today = new Date().toLocaleDateString();
            return records.some(record => record.date === today && record.type === type && record.userId === userProfile.userId);
        }

        async function clock(type) {
            if (!userProfile) return;
            if (isAlreadyClockedToday(type)) { alert(`今天已打過「${type}」卡！`); return; }

            const record = {
                userId: userProfile.userId,
                name: userProfile.displayName,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                type: type
            };
            saveRecordToLocal(record);

            try {
                await fetch("https://your-backend-api.com/attendance", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(record)
                });
                alert(type + "打卡成功！");
            } catch { alert(type + "打卡失敗！"); }
        }

        function clearLocalRecords() {
            if (confirm("確定清除本地紀錄？")) {
                localStorage.removeItem(STORAGE_KEY);
                document.querySelector("#report-table tbody").innerHTML = "";
                alert("已清除紀錄");
            }
        }

        function generateReport() {
            const reportType = document.getElementById("report-type").value;
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const tbody = document.querySelector("#report-table tbody");
            tbody.innerHTML = "";

            const now = new Date();
            let startDate;

            if (reportType === "week") {
                const dayOfWeek = now.getDay();
                startDate = new Date(now);
                startDate.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // 本週週一
            } else if (reportType === "month") {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }

            // 建立日期列表
            const endDate = new Date(now);
            let dateList = [];
            let d = new Date(startDate);
            while (d <= endDate) {
                dateList.push(d.toLocaleDateString());
                d.setDate(d.getDate() + 1);
            }

            // 計算每日統計
            dateList.forEach(date => {
                const dayRecords = records.filter(r => r.date === date);
                const clockInCount = dayRecords.filter(r => r.type === "上班").length;
                const clockOutCount = dayRecords.filter(r => r.type === "下班").length;

                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${date}</td><td>${clockInCount}</td><td>${clockOutCount}</td>`;
                tbody.appendChild(tr);
            });
        }

        document.getElementById("clock-in").addEventListener("click", () => clock("上班"));
        document.getElementById("clock-out").addEventListener("click", () => clock("下班"));
        document.getElementById("clear-records").addEventListener("click", clearLocalRecords);
        document.getElementById("generate-report").addEventListener("click", generateReport);

        initializeLiff();
    </script>
</body>
</html>










