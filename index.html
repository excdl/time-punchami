<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬å¸æ‰“å¡ç³»çµ± (LIFF)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:"Microsoft JhengHei",sans-serif;background:#f6f7fb;padding:20px;text-align:center;}
.container{max-width:420px;margin:auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);}
button{width:100%;padding:15px;margin:10px 0;border-radius:10px;border:none;font-size:18px;color:white;font-weight:bold;cursor:pointer;}
.btn-start{background:#28a745;}
.btn-end{background:#dc3545;}
#status{margin-top:20px;white-space:pre-wrap;}
#records{margin-top:10px;text-align:left;background:#f0f0f0;padding:10px;border-radius:8px;}
.green{color:green;font-weight:bold;}
.red{color:red;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
<h2>å…¬å¸æ‰“å¡ç³»çµ±</h2>
<div id="profile">å–å¾— LINE ä½¿ç”¨è€…è³‡æ–™ä¸­...</div>
<div id="status"></div>
<h3>ä»Šæ—¥æ‰“å¡ç´€éŒ„</h3>
<div id="records">è¼‰å…¥ä¸­...</div>
<button class="btn-start" onclick="send('ä¸Šç­')">ğŸŸ¢ ä¸Šç­</button>
<button class="btn-end" onclick="send('ä¸‹ç­')">ğŸ”´ ä¸‹ç­</button>
</div>

<script>
const LIFF_ID = "2008499706-eBayB9Yd"; // æ›¿æ›æˆä½ çš„ LIFF ID
let lineUserId = "";
let lineUserName = "";

// å–å¾—ç”¨æˆ¶ IP
async function getClientIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip || "ä¸æ˜";
  } catch {
    return "ä¸æ˜";
  }
}

// åˆå§‹åŒ– LIFF
async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    lineUserId = profile.userId;
    lineUserName = profile.displayName;
    document.getElementById("profile").innerText = `ğŸ‘¤ ${lineUserName} æ‚¨å¥½`;
    loadRecords();
  } catch(e) {
    document.getElementById("profile").innerText = "âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message;
  }
}

// æ‰“å¡
async function send(action) {
  const clientIp = await getClientIP();
  google.script.run.withSuccessHandler(updateStatus)
    .handleClockInOut(lineUserId, lineUserName, action, clientIp);
}

// è¼‰å…¥ä»Šæ—¥ç´€éŒ„
function loadRecords() {
  google.script.run.withSuccessHandler(updateRecords)
    .queryRecords(lineUserId);
}

// æ›´æ–°æ‰“å¡ç‹€æ…‹
function updateStatus(res) {
  if(res.status === "success") {
    let colorClass = "green";
    // ä¸Šç­é²åˆ°æˆ–ä¸‹ç­æ—©é€€é¡¯ç¤ºç´…è‰²
    if((res.reminder.includes("æ™šäº†") && res.message.includes("ä¸Šç­")) || 
       (res.reminder.includes("æå‰") && res.message.includes("ä¸‹ç­"))) {
      colorClass = "red";
    }
    document.getElementById("status").innerHTML = `<span class="${colorClass}">${res.message}ï¼ˆ${res.reminder}ï¼‰</span> IP: ${res.ipStatus}`;
    loadRecords();
  } else {
    document.getElementById("status").innerHTML = `<span class="red">${res.message}</span>`;
  }
}

// æ›´æ–°ç´€éŒ„é¡¯ç¤º
function updateRecords(res) {
  const container = document.getElementById("records");
  container.innerHTML = "";
  res.records.forEach(r => {
    let colorClass = "green";
    if(r.includes("æ™šäº†") && r.includes("ä¸Šç­") || r.includes("æå‰") && r.includes("ä¸‹ç­")) {
      colorClass = "red";
    }
    const div = document.createElement("div");
    div.className = colorClass;
    div.innerText = r;
    container.appendChild(div);
  });
}

// åˆå§‹åŒ–
initLIFF();
</script>
</body>
</html>





