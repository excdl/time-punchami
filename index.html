<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Line 打卡系統</title>
  <script src="https://static.line-scdn.net/liff/2.22/sdk.js"></script>
</head>
<body>
  <h2>打卡系統</h2>
  <button id="checkinBtn">立即打卡</button>

  <script>
    let userProfile = null;

    // 初始化 LIFF
    async function initLiff() {
      try {
        await liff.init({ liffId: "2008499706-eBayB9Yd" });
        console.log("LIFF 初始化成功");

        // 確認使用者已登入
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // 取得使用者資訊
        userProfile = await liff.getProfile();
        console.log("使用者資料:", userProfile);
      } catch (err) {
        console.error("LIFF 初始化錯誤:", err);
      }
    }

    // 取得使用者 IP
    async function getUserIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch (err) {
        console.error("無法取得 IP:", err);
        return "無法取得 IP";
      }
    }

    // 點擊打卡
    async function checkin() {
      if (!userProfile) {
        alert("使用者資訊尚未取得，請重新整理頁面。");
        return;
      }

      const ip = await getUserIP();
      const now = new Date();
      const payload = {
        userId: userProfile.userId,
        displayName: userProfile.displayName,
        date: now.toLocaleDateString("zh-TW"),
        time: now.toLocaleTimeString("zh-TW"),
        ip: ip
      };

      console.log("打卡資料:", payload);

      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbxzxN2Cn9C_RDNWqnQHnL2prnMHpFQ05vfaLohRH3VYq2chny8kDNba5hhYskZoCMnz/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        console.log("GAS 回應:", text);
        alert("打卡完成！\nGAS 回應：" + text);
      } catch (err) {
        console.error("送出打卡失敗:", err);
        alert("打卡失敗：" + err);
      }
    }

    // 綁定按鈕
    document.getElementById("checkinBtn").onclick = checkin;

    // 執行初始化
    window.onload = initLiff;
  </script>
</body>
</html>










