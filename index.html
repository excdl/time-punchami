<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬å¸æ‰“å¡ç³»çµ± (LIFF)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:"Microsoft JhengHei",sans-serif;background:#f6f7fb;padding:20px;text-align:center;}
.container{max-width:420px;margin:auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);}
button{width:100%;padding:15px;margin:10px 0;border-radius:10px;border:none;font-size:18px;color:white;font-weight:bold;cursor:pointer;}
.btn-start{background:#28a745;}
.btn-end{background:#dc3545;}
#status{margin-top:20px;white-space:pre-wrap;}
#records{margin-top:10px;text-align:left;background:#f0f0f0;padding:10px;border-radius:8px;}
.smart-reminder{color:#ff5722;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
<h2>å…¬å¸æ‰“å¡ç³»çµ±</h2>
<div id="profile">å–å¾—ä½¿ç”¨è€…è³‡æ–™ä¸­...</div>
<div id="ip">å–å¾— IP ä¸­...</div>
<button class="btn-start" onclick="send('ä¸Šç­')">ğŸŸ¢ ä¸Šç­</button>
<button class="btn-end" onclick="send('ä¸‹ç­')">ğŸ”´ ä¸‹ç­</button>
<div id="status"></div>
<h3>ä»Šæ—¥æ‰“å¡ç´€éŒ„</h3>
<div id="records">è¼‰å…¥ä¸­...</div>
</div>

<script>
const LIFF_ID = "2008499706-eBayB9Yd"; // æ›¿æ›ä½ çš„ LIFF ID
const GAS_URL = "https://script.google.com/macros/s/AKfycbyEPjqkZmacL8TILrWc13Bg_S6geDLHY7zxQgaJ6RTCrfqhQEuF0aPSBzrblpnCVoqn/exec"; // æ›¿æ›ä½ çš„ Web App URL
let lineUserName = "";
let userIP = "";

// é è¨­ä¸Šç­/ä¸‹ç­æ™‚é–“ (24å°æ™‚åˆ¶)
const defaultTimes = {
  ä¸Šç­: "09:00",
  ä¸‹ç­: "18:00"
};

// åˆå§‹åŒ– LIFF
async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    lineUserName = profile.displayName;
    document.getElementById("profile").innerText = `ğŸ‘¤ ${lineUserName} æ‚¨å¥½`;
    
    userIP = await getIP(); // å–å¾— IP ä¸¦é¡¯ç¤º
    loadRecords();
  } catch (e) {
    document.getElementById("profile").innerText = "âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message;
  }
}

// å–å¾—ä½¿ç”¨è€… IP ä¸¦åˆ¤æ–·å…¬å¸ç¶²è·¯
async function getIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    const ip = data.ip;
    const ipDisplay = document.getElementById("ip");

    // å‡è¨­å…¬å¸ IP ç¯„åœæ˜¯ 192.168.1.*
    if (/^192\.168\.1\.\d{1,3}$/.test(ip)) {
      ipDisplay.innerHTML = `ğŸŒ é€£ç·šå…¬å¸ç¶²è·¯: <span style="color:green">${ip}</span>`;
    } else {
      ipDisplay.innerHTML = `ğŸŒ ä¸æ˜é€£ç·š: <span style="color:red">${ip}</span>`;
    }
    return ip;
  } catch {
    document.getElementById("ip").innerHTML = `ğŸŒ ç„¡æ³•å–å¾— IP`;
    return "ç„¡æ³•å–å¾—";
  }
}

// å‘¼å« GAS æ‰“å¡
async function send(action) {
  document.getElementById("status").innerText = "â³ è«‹æ±‚ä¸­...";
  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userName: lineUserName, message: action, ip: userIP })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    document.getElementById("status").innerText = "ğŸ“© å›æ‡‰ï¼š\n" + JSON.stringify(data,null,2);
    loadRecords();
  } catch(err) {
    document.getElementById("status").innerText = "âŒ è«‹æ±‚éŒ¯èª¤ï¼š" + err.message;
  }
}

// è¼‰å…¥ä»Šæ—¥ç´€éŒ„
async function loadRecords() {
  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userName: lineUserName, message: "æŸ¥è©¢" })
    });
    const data = await res.json();
    if (data.status === "success" && data.type === "query") {
      const records = data.records.map(r => addTimeReminder(r));
      document.getElementById("records").innerHTML = records.join("<br>");
    } else {
      document.getElementById("records").innerText = "ä»Šæ—¥ç„¡æ‰“å¡ç´€éŒ„";
    }
  } catch(err) {
    document.getElementById("records").innerText = "âŒ è«‹æ±‚éŒ¯èª¤ï¼š" + err.message;
  }
}

// è¨ˆç®—èˆ‡é è¨­æ™‚é–“å·®
function addTimeReminder(record) {
  const parts = record.split(" : "); // [action, time]
  if (parts.length !== 2) return record;
  const action = parts[0];
  const timeStr = parts[1];
  const defaultTime = defaultTimes[action];
  if (!defaultTime) return record;

  const [h1,m1] = defaultTime.split(":").map(Number);
  const [h2,m2] = timeStr.split(":").map(Number);
  const diffMinutes = (h2*60 + m2) - (h1*60 + m1);

  let reminder = "";
  if (diffMinutes > 0) reminder = `ï¼ˆæ™šäº† ${diffMinutes} åˆ†é˜ï¼‰`;
  else if (diffMinutes < 0) reminder = `ï¼ˆæå‰ ${-diffMinutes} åˆ†é˜ï¼‰`;
  else reminder = `ï¼ˆæº–æ™‚ï¼‰`;

  return `${record} <span class="smart-reminder">${reminder}</span>`;
}

window.onload = initLIFF;
</script>
</body>
</html>



