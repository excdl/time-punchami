<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¬å¸æ‰“å¡ç³»çµ± (LIFF)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:"Microsoft JhengHei",sans-serif;background:#f6f7fb;padding:20px;text-align:center;}
.container{max-width:420px;margin:auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);}
button{width:100%;padding:15px;margin:10px 0;border-radius:10px;border:none;font-size:18px;color:white;font-weight:bold;cursor:pointer;transition: all 0.3s ease;}
button:disabled{opacity:0.5;cursor:not-allowed;}
.btn-start{background:#28a745;}
.btn-end{background:#dc3545;}
#status,#ip{margin-top:10px;white-space:pre-wrap;}
#records{margin-top:10px;text-align:left;background:#f0f0f0;padding:10px;border-radius:8px;}
.smart-reminder{color:#ff5722;font-weight:bold;}
.animated-check {
  display: inline-block;
  margin-left: 10px;
  opacity: 0;
  transform: scale(0);
  transition: all 0.5s ease-out;
  color: #fff;
}
.show-check {
  opacity: 1;
  transform: scale(1.2);
}
</style>
</head>
<body>
<div class="container">
<h2>å…¬å¸æ‰“å¡ç³»çµ±</h2>
<div id="profile">å–å¾— LINE ä½¿ç”¨è€…è³‡æ–™ä¸­...</div>
<div id="ip">å–å¾— IP ä¸­...</div>
<button id="btnStart" class="btn-start" onclick="send('ä¸Šç­', this)">ğŸŸ¢ ä¸Šç­<span class="animated-check">âœ…</span></button>
<button id="btnEnd" class="btn-end" onclick="send('ä¸‹ç­', this)">ğŸ”´ ä¸‹ç­<span class="animated-check">âœ…</span></button>
<div id="status"></div>
<h3>ä»Šæ—¥æ‰“å¡ç´€éŒ„</h3>
<div id="records">è¼‰å…¥ä¸­...</div>
</div>

<script>
const LIFF_ID = "2008499706-eBayB9Yd"; // æ›¿æ›ä½ çš„ LIFF ID
const GAS_URL = "https://script.google.com/macros/s/AKfycbyEPjqkZmacL8TILrWc13Bg_S6geDLHY7zxQgaJ6RTCrfqhQEuF0aPSBzrblpnCVoqn/exec"; // æ›¿æ›ä½ çš„ Web App URL
let lineUserName = "";
let userIP = "";

// åˆå§‹åŒ– LIFF
async function initLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    lineUserName = profile.displayName;
    document.getElementById("profile").innerText = `ğŸ‘¤ ${lineUserName} æ‚¨å¥½`;
    userIP = await getIP();
    document.getElementById("ip").innerText = `ğŸŒ IP: ${userIP}`;
    loadRecords();
  } catch (e) {
    document.getElementById("profile").innerText = "âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message;
  }
}

// å–å¾—ä½¿ç”¨è€… IP
async function getIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch {
    return "ç„¡æ³•å–å¾—";
  }
}

// å‘¼å« GAS æ‰“å¡
async function send(action, btn) {
  disableButtons(true);
  document.getElementById("status").innerText = "â³ è«‹æ±‚ä¸­...";
  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userName: lineUserName, message: action, ip: userIP })
    });
    const data = await res.json();
    document.getElementById("status").innerText = "ğŸ“© å›æ‡‰ï¼š\n" + JSON.stringify(data,null,2);

    // é¡¯ç¤ºå‹•ç•«å‹¾å‹¾
    const check = btn.querySelector(".animated-check");
    check.classList.add("show-check");

    loadRecords();
  } catch(err) {
    document.getElementById("status").innerText = "âŒ è«‹æ±‚éŒ¯èª¤ï¼š" + err.message;
    disableButtons(false);
  }
}

// è¼‰å…¥ä»Šæ—¥ç´€éŒ„
async function loadRecords() {
  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userName: lineUserName, message: "æŸ¥è©¢" })
    });
    const data = await res.json();
    if (data.status === "success" && data.type === "query") {
      const records = data.records.map(r => addTimeReminder(r));
      document.getElementById("records").innerHTML = records.join("<br>");
      updateButtonState(data.records);
    } else {
      document.getElementById("records").innerText = "ä»Šæ—¥ç„¡æ‰“å¡ç´€éŒ„";
      disableButtons(false);
    }
  } catch(err) {
    document.getElementById("records").innerText = "âŒ è«‹æ±‚éŒ¯èª¤ï¼š" + err.message;
    disableButtons(false);
  }
}

// è¨ˆç®—é²åˆ°/æå‰/æº–æ™‚
function addTimeReminder(record) {
  const defaultTimes = { ä¸Šç­: "09:00", ä¸‹ç­: "18:00" };
  const parts = record.split(" : ");
  if (parts.length !== 2) return record;
  const action = parts[0];
  const timeStr = parts[1];
  const defaultTime = defaultTimes[action];
  if (!defaultTime) return record;

  const [h1,m1] = defaultTime.split(":").map(Number);
  const [h2,m2] = timeStr.split(":").map(Number);
  const diffMinutes = (h2*60 + m2) - (h1*60 + m1);
  let reminder = "";
  if (diffMinutes > 0) reminder = `ï¼ˆæ™šäº† ${diffMinutes} åˆ†é˜ï¼‰`;
  else if (diffMinutes < 0) reminder = `ï¼ˆæå‰ ${-diffMinutes} åˆ†é˜ï¼‰`;
  else reminder = `ï¼ˆæº–æ™‚ï¼‰`;

  return `${record} <span class="smart-reminder">${reminder}</span>`;
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonState(records) {
  let hasStart = records.some(r => r.startsWith("ä¸Šç­"));
  let hasEnd = records.some(r => r.startsWith("ä¸‹ç­"));
  const btnStart = document.getElementById("btnStart");
  const btnEnd = document.getElementById("btnEnd");
  btnStart.disabled = hasStart;
  btnEnd.disabled = hasEnd;

  // é¡¯ç¤ºå‹•ç•«å‹¾å‹¾
  if(hasStart) btnStart.querySelector(".animated-check").classList.add("show-check");
  if(hasEnd) btnEnd.querySelector(".animated-check").classList.add("show-check");
}

// é–å®šæŒ‰éˆ•
function disableButtons(flag) {
  document.getElementById("btnStart").disabled = flag;
  document.getElementById("btnEnd").disabled = flag;
}

initLIFF();
</script>
</body>
</html>









