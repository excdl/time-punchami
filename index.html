<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f4f4f9; margin:0; padding:10px; text-align:center;}
h3 { font-size:24px; margin-bottom:10px; color:#2c3e50; }
button { margin:5px; padding:10px 20px; font-size:16px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;}
#btnStart { background-color:#3498db; color:white; }
#btnEnd { background-color:#e74c3c; color:white; }
#btnMakeup { background-color:#f39c12; color:white; }
#todayRecords { margin-top:20px; text-align:left; max-width:400px; margin-left:auto; margin-right:auto; }
.recordItem { padding:5px; border-bottom:1px solid #ddd; }
.success { color:#4CAF50; }
.error { color:#e74c3c; }
</style>
</head>
<body>

<h3 id="greeting">è¼‰å…¥ä¸­...</h3>

<div>
  <button id="btnStart">ä¸Šç­æ‰“å¡</button>
  <button id="btnEnd">ä¸‹ç­æ‰“å¡</button>
  <button id="btnMakeup">è£œæ‰“å¡</button>
</div>

<div id="todayRecords">
  <h4>ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š</h4>
  <div id="recordList">è¼‰å…¥ä¸­...</div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzpXHAWr2WkfnhTBgynSb_A4KOBrXKuiCOxD155Zh_VH_-av2WnnwiTk8XhsONEo4cM/exec";
const COMPANY_IPS = ["114.34.60.48","27.240.227.0"];

function formatDateTime(d){
  const date = d.toLocaleDateString('zh-TW');
  const time = d.toLocaleTimeString('zh-TW');
  return {date, time};
}

async function getIP(){
  try{
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  }catch(e){ return ""; }
}

async function performClockIn(status, isMakeup=false, customDate="", customTime=""){
  const profile = await liff.getProfile();
  const userId = profile.userId;
  const displayName = profile.displayName;
  const ip = await getIP();

  const res = await fetch(API_ENDPOINT,{
    method:"POST",
    body: JSON.stringify({userId, displayName, status, ip, isMakeup, customDate, customTime})
  });
  const result = await res.json();

  if(isMakeup){
    Swal.fire("è£œæ‰“å¡æˆåŠŸ","å¾…ä¸»ç®¡æ‰¹æ ¸","success");
  }else{
    if(COMPANY_IPS.includes(ip)){
      Swal.fire("ğŸ˜€ æ‰“å¡æˆåŠŸ", `${status} ${result.date} ${result.time}`, "success");
    }else{
      Swal.fire("âŒ é€£ç·šéŒ¯èª¤", "éå…¬å¸ç¶²è·¯ï¼Œç„¡æ³•æ‰“å¡","error");
    }
  }
  loadTodayRecords();
}

function showMakeupDialog(){
  Swal.fire({
    title:"è£œæ‰“å¡è¨­å®š",
    html: `
      <label>æ—¥æœŸ: <input type="date" id="makeupDate" class="swal2-input"></label>
      <label>æ™‚é–“: <input type="time" id="makeupTime" class="swal2-input"></label>
      <label>å‹•æ…‹: 
        <select id="makeupStatus" class="swal2-input">
          <option value="ä¸Šç­">ä¸Šç­</option>
          <option value="ä¸‹ç­">ä¸‹ç­</option>
        </select>
      </label>
    `,
    focusConfirm:false,
    confirmButtonText:"å®Œæˆ",
    preConfirm: () => {
      const date = document.getElementById("makeupDate").value;
      const time = document.getElementById("makeupTime").value;
      const status = document.getElementById("makeupStatus").value;
      if(!date || !time) Swal.showValidationMessage("è«‹å¡«å¯«å®Œæ•´æ—¥æœŸæ™‚é–“");
      return {date, time, status};
    }
  }).then(result=>{
    if(result.isConfirmed){
      performClockIn(result.value.status,true,result.value.date,result.value.time);
    }
  });
}

async function loadTodayRecords(){
  const profile = await liff.getProfile();
  const userId = profile.userId;
  const today = new Date();
  const dateStr = today.toISOString().split("T")[0];

  const res = await fetch(`${API_ENDPOINT}?action=todayRecords&userId=${userId}&date=${dateStr}`);
  const records = await res.json();

  const recordList = document.getElementById("recordList");
  if(records.length===0){
    recordList.innerHTML="<div class='recordItem'>ç„¡æ‰“å¡ç´€éŒ„</div>";
  }else{
    recordList.innerHTML = records.map(r=>{
      const cls = r.isMakeup?"success":"success";
      return `<div class='recordItem ${cls}'>${r.status} ${r.time} ${r.isMakeup?"(è£œæ‰“å¡)":""}</div>`;
    }).join("");
  }
}

async function main(){
  await liff.init({liffId:"2008504718-nmXP0WRV"});
  if(!liff.isLoggedIn()) liff.login();

  const profile = await liff.getProfile();
  document.getElementById("greeting").innerText = `${profile.displayName} æ‚¨å¥½`;

  document.getElementById("btnStart").onclick = ()=>performClockIn("ä¸Šç­");
  document.getElementById("btnEnd").onclick = ()=>performClockIn("ä¸‹ç­");
  document.getElementById("btnMakeup").onclick = ()=>showMakeupDialog();

  loadTodayRecords();
}

window.onload = main;
</script>
</body>
</html>

























