<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f4f4f9; color:#333; display:flex; flex-direction:column; align-items:center; padding:10px; }
h3 { font-size:24px; margin-bottom:10px;}
button { margin:5px; padding:10px 20px; font-size:16px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;}
#btnStart { background:#3498db; color:#fff; }
#btnEnd { background:#e74c3c; color:#fff; }
#btnMakeUp { background:#f39c12; color:#fff; }
#makeUpModal { display:none; padding:20px; border:1px solid #ccc; background:#fff; position:fixed; top:20%; left:50%; transform:translateX(-50%); z-index:999; }
#makeUpModal label { display:block; margin:5px 0; }
#todayRecords { margin-top:20px; padding:10px; border:1px solid #ccc; background:#fff; width:90%; max-width:400px; }
</style>
</head>
<body>
<h3>奇可智能打卡系統</h3>
<p id="currentDate">正在獲取現在時刻...</p>

<div>
<button id="btnStart">上班打卡</button>
<button id="btnEnd">下班打卡</button>
<button id="btnMakeUp">補打卡</button>
</div>

<div id="todayRecords">
<h4>今日打卡紀錄</h4>
<ul id="recordList"><li>載入中...</li></ul>
</div>

<!-- 補打卡模態框 -->
<div id="makeUpModal">
  <h3>補打卡</h3>
  <label>日期: <input type="date" id="makeUpDate"></label>
  <label>時間: <input type="time" id="makeUpTime"></label>
  <label>上班/下班: 
    <select id="makeUpStatus">
      <option value="上班">上班</option>
      <option value="下班">下班</option>
    </select>
  </label>
  <br>
  <button id="submitMakeUp">送出補打卡</button>
  <button id="cancelMakeUp">取消</button>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbwCIwPGvmI99Turk5Hfwxa_915IF7O6AS9ejmw2UtIyvOBle_n2P3Asj4ZR4EIUeR4a/exec"; // 替換成你的 GAS API

// 顯示當前時間
function updateCurrentTime() {
    const now = new Date();
    document.getElementById("currentDate").textContent = "現在時刻: " + now.toLocaleString("zh-TW");
}
setInterval(updateCurrentTime, 1000);
updateCurrentTime();

// 打卡函式
async function clockIn(status, date=null, time=null, isMakeUp=false){
    const profile = await liff.getProfile();
    const userId = profile.userId;
    const displayName = profile.displayName;

    const ipRes = await fetch("https://api.ipify.org?format=json").then(r=>r.json()).catch(()=>({ip:""}));
    const ip = ipRes.ip || "";

    const payload = { userId, displayName, ip, status, isMakeUp };
    if(date) payload.date = date;
    if(time) payload.time = time;

    const res = await fetch(API_ENDPOINT, { method:"POST", body:JSON.stringify(payload) });
    const data = await res.json();

    if(data.message==="寫入成功"){
        Swal.fire('成功', isMakeUp?"補打卡已寫入":"打卡成功","success");
        loadTodayRecords();
        if(!isMakeUp) updateLockButtons();
    } else {
        Swal.fire('失敗', data.message || '打卡失敗','error');
    }
}

// 讀取今日打卡紀錄
async function loadTodayRecords(){
    const profile = await liff.getProfile();
    const userId = profile.userId;
    const today = new Date().toISOString().split("T")[0];

    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    const list = document.getElementById("recordList");
    list.innerHTML = "";
    if(data.records && data.records.length){
        data.records.forEach(r=>{
            let li = document.createElement("li");
            li.textContent = `${r.status} - ${r.time} ${r.makeUp?"(補打卡)":""}`;
            list.appendChild(li);
        });
    } else {
        list.innerHTML="<li>尚未打卡</li>";
    }
}

// 檢查鎖定按鈕
async function updateLockButtons(){
    const profile = await liff.getProfile();
    const userId = profile.userId;
    const today = new Date().toISOString().split("T")[0];

    const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
    const data = await res.json();
    const btnStart = document.getElementById("btnStart");
    const btnEnd = document.getElementById("btnEnd");

    btnStart.disabled = data.records?.some(r=>r.status==="上班" && !r.makeUp) || false;
    btnEnd.disabled = data.records?.some(r=>r.status==="下班" && !r.makeUp) || false;
}

// 自動每天 00:00 解鎖按鈕
function scheduleUnlock(){
    const now = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(now.getDate()+1);
    tomorrow.setHours(0,0,0,0);
    const ms = tomorrow.getTime() - now.getTime();
    setTimeout(()=>{
        document.getElementById("btnStart").disabled=false;
        document.getElementById("btnEnd").disabled=false;
        scheduleUnlock(); // 每天循環
    }, ms);
}

// 主程式
async function main(){
    await liff.init({ liffId:"2008504718-nmXP0WRV" });
    if(!liff.isLoggedIn()) liff.login();

    document.getElementById("btnStart").onclick = ()=>clockIn("上班");
    document.getElementById("btnEnd").onclick = ()=>clockIn("下班");
    document.getElementById("btnMakeUp").onclick = ()=> document.getElementById("makeUpModal").style.display="block";
    document.getElementById("cancelMakeUp").onclick = ()=> document.getElementById("makeUpModal").style.display="none";

    document.getElementById("submitMakeUp").onclick = ()=>{
        const date = document.getElementById("makeUpDate").value;
        const time = document.getElementById("makeUpTime").value;
        const status = document.getElementById("makeUpStatus").value;
        if(!date || !time){ Swal.fire('錯誤','請選擇日期與時間','error'); return; }
        clockIn(status, date, time, true);
        document.getElementById("makeUpModal").style.display="none";
    };

    await loadTodayRecords();
    await updateLockButtons();
    scheduleUnlock();
}

window.onload = main;
</script>
</body>
</html>






















