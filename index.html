<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>奇可智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: Arial, sans-serif; background-color: #f4f4f9; color:#333; display:flex; flex-direction:column; align-items:center; padding:10px;}
h3 { font-size:24px; font-weight:600; color:#2c3e50; margin-bottom:10px;}
button { margin:10px; padding:10px 20px; font-size:16px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;}
#btnStart { background-color:#3498db; color:white;}
#btnEnd { background-color:#e74c3c; color:white;}
#btnQuery { background-color:#27ae60; color:white;}
button:disabled { opacity:0.5; cursor:not-allowed; }
</style>
</head>

<body>
<h3>謝謝使用奇可智能打卡系統</h3>
<p id="currentDate">正在獲取現在時刻...</p>

<div>
  <button id="btnStart">上班打卡</button>
  <button id="btnEnd">下班打卡</button>
  <button id="btnQuery">查詢今日紀錄</button>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyefPKlbEbNMGFAX4yidJVgUexAOkbTInC_Yckjfmy1zRjH061o2_ivkwv4_yrFdmrs/exec";

// ----------------------
// 每秒更新時鐘
// ----------------------
setInterval(() => {
  document.getElementById("currentDate").textContent =
    "現在時刻: " + new Date().toLocaleString("zh-TW");
}, 1000);

// ----------------------
// 取得 IP
// ----------------------
async function getIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch {
    return "";
  }
}

// ----------------------
// 呼叫 GAS API
// ----------------------
async function callAPI(body) {
  const res = await fetch(API_ENDPOINT, {
    method: "POST",
    body: JSON.stringify(body)
  });
  return await res.json();
}

// ----------------------
// 按鈕鎖定管理
// ----------------------
function isLocked(status) {
  const lock = JSON.parse(localStorage.getItem(status + "_lock") || "null");
  if (!lock) return false;
  const today = new Date().toISOString().split("T")[0];
  return lock.date === today;
}

function setLocked(status) {
  const today = new Date().toISOString().split("T")[0];
  localStorage.setItem(status + "_lock", JSON.stringify({ date: today }));
}

// ----------------------
// 打卡主程式
// ----------------------
async function clockIn(status) {
  const profile = await liff.getProfile();
  const userId = profile.userId;
  const displayName = profile.displayName;
  const ip = await getIP();

  const result = await callAPI({ status, ip, userId, displayName });

  if (status === "查詢") {
    const rec = result.records || [];
    Swal.fire({
      icon: "info",
      title: "今日打卡紀錄",
      html: rec.length ? rec.join("<br>") : "無紀錄",
      confirmButtonText: "OK"
    });
    return;
  }

  if (result.message === "距離上班不足 30 分鐘，請晚點再打卡") {
    Swal.fire({
      icon: "warning",
      title: "尚不能下班打卡",
      html: "距離上班時間未達 30 分鐘，請稍後再試",
      confirmButtonText: "OK"
    });
    return;
  }

  if (result.message === "寫入成功" || result.message === "已打卡") {
    Swal.fire({
      icon: "success",
      title: "打卡成功",
      html: `${result.date} ${result.time}`,
      timer: 2000
    });

    if (status === "上班") {
      setLocked("上班");
      document.getElementById("btnStart").disabled = true;
    }
    if (status === "下班") {
      setLocked("下班");
      document.getElementById("btnEnd").disabled = true;
    }
    return;
  }

  if (result.ipStatus === "異地打卡請忽略") {
    Swal.fire({
      icon: "warning",
      title: "異地打卡",
      html: "IP 不符，將不列入正式打卡紀錄<br>（仍已寫入系統）",
      confirmButtonText: "OK"
    });
    return;
  }

  Swal.fire({
    icon: "error",
    title: "打卡失敗",
    text: result.message || "請稍後再試"
  });
}

// ----------------------
// 初始化按鈕
// ----------------------
function initButtons() {
  const btnStart = document.getElementById("btnStart");
  const btnEnd = document.getElementById("btnEnd");
  const btnQuery = document.getElementById("btnQuery");

  btnStart.disabled = isLocked("上班");
  btnEnd.disabled = isLocked("下班");

  btnStart.onclick = async () => await clockIn("上班");
  btnEnd.onclick = async () => await clockIn("下班");
  btnQuery.onclick = async () => await clockIn("查詢");
}

// ----------------------
// 每分鐘檢查下班打卡是否可用
// ----------------------
async function checkEndButton() {
  const btnEnd = document.getElementById("btnEnd");
  if (btnEnd.disabled) return;

  const profile = await liff.getProfile();
  const userId = profile.userId;
  const displayName = profile.displayName;
  const ip = await getIP();

  // 後端檢查是否可以下班打卡（30 分鐘限制）
  const result = await callAPI({ status: "下班", ip, userId, displayName });
  if (result.message === "距離上班不足 30 分鐘，請晚點再打卡") {
    btnEnd.disabled = true;
    btnEnd.textContent = "下班打卡 (尚不可用)";
  } else {
    btnEnd.disabled = isLocked("下班");
    btnEnd.textContent = "下班打卡";
  }
}

// ----------------------
// 主程式
// ----------------------
async function main() {
  await liff.init({ liffId: "2008504718-nmXP0WRV" });
  if (!liff.isLoggedIn()) liff.login();

  initButtons();
  checkEndButton(); // 初始化檢查一次
  setInterval(checkEndButton, 60000); // 每分鐘檢查一次
}

window.onload = main;
</script>
</body>
</html>























